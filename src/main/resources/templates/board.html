<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your HTML Document</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!-- 외부 스타일 시트를 링크합니다. -->
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"
            integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
</head>
<body>
<div id="p1" class="mdl-progress mdl-js-progress"></div>

<script>
    document.querySelector('#p1').addEventListener('mdl-componentupgraded', function () {
        this.MaterialProgress.setProgress(44);
    });

    let lastColumnPosition = 0;
    var colresponsedto = {}

    $(document).ready(function () {
        const authToken = getAuthorizationToken();
        loadColumns(1, authToken);
        $("#delete-button").click(function () {
            addItem();
        });
        $("#add-column").click(function () {
            addColumn(authToken);
        });

        // 정민님 컬럼 카드 불러오기 로직
        // $("body").on("click", "button#test-button", function(){
        //     console.log("add button 동작");
        //     var buttonId = $(this).attr("id");
        //     addItem($(this).closest('ol'));
        // });
        //
        // showColumn();
        // loadAllCard_pjm();
        //
        // $("#test-button").click(function(){
        //     addItem();
        // });

        // 정민님 컬럼 카드 불러오기 로직


    });

    function loadAllCard_pjm() {
        const authToken = getAuthorizationToken();
        $.ajax({
            url: '/cards/boards/' + window.location.pathname.split('/')[2],
            type: 'GET',
            headers: {
                'Authorization': authToken
            },
            success: function (data) {
                lst = $('.kanban.columnId h2')
                console.log("list = ", lst)
                idx_set = new Set();
                for (const val of lst) {
                    idx_set.add(Number(val.id))
                }
                console.log("idx_set = ", idx_set)
                for (let i of idx_set) {
                    const todoList = $('#todo-list-' + i);
                    for (const card of data) {
                        console.log("card Object", card)
                        if (i == card.columnId) {
                            todoList.append(
                                `<li class="dd-item" id="todo-${card.id}">
                            <h3 class="title dd-handle">${card.name}</h3>
                            <div class="text" contenteditable="true">
                                ${card.description}
                            </div>
                            <i class="material-icons" id="label blue">label</i>
                            <div class="actions">
                                <i class="material-icons" id="color">palette</i><i class="material-icons">edit</i><i class="material-icons">insert_link</i><i class="material-icons">attach_file</i>
                            </div>
                        </li>`
                            );
                        }
                    }
                }
            },
            error: function (error) {
                console.log('Error:', error);
            }
        });
    }

    const columnTemplate =
        `
        <ol class="column" id="column-{columnId}">
            <div class="kanban__title">
                <h2 style="font-family: 'Poppins', sans-serif;">{name}</h2>
            </div>

            <div class="todo-list" id="todo-list">
<!--                카드들이 들어갈곳-->
            </div>

            <div class="actions">
                <button id="create-card" class="addbutt" onclick="openModal({columnId})">ADD NEW</button>
            </div>
        </ol>
        `


    const cardTemplate =
        `
        <li class="dd-item" id="card-{card_id}" >
            <input type="hidden" id="cardIdValue" name="cardIdValue">
            <span class="close" onclick="deleteCardForm(this)">&times;</span>
            <h3 class="title dd-handle" style="text-align:center;">
                {card_name}
            </h3>
            <div class="text" contenteditable="true">
                {card_description}
            </div>
<!--            <div class="actions">-->
<!--               {card_dueDate}-->
<!--            </div>-->
        </li>
        `


    // 정민님 함수
    // 정민님 함수
    function showColumn() {
        var pathname = window.location.pathname;
        console.log(pathname);
        const authToken = getAuthorizationToken();
        $.ajax({
            type: 'GET',
            url: `/columns/boards/` + window.location.pathname.split('/')[2],
            headers: {
                'Authorization': authToken
            },
            data: colresponsedto,
            success: function (data) {
                const dd = $(".dd");
                dd.empty();
                for (const column of data) {
                    let tempHtml = addHTML(column)
                    dd.append(tempHtml);
                }
            },
            error(error, status, request) {
            }
        })
    }

    function addHTML(column) {
        console.log("column id = ", column)
        return `<ol class = "kanban columnId ${column.columnId}">
                   <div class="kanban__title" id="todo-list-${column.columnId}">
                    <h2 id="${column.columnId}"><i class="material-icons">${column.title}</i></h2>
                    <button id="test-button" className="addbutt"><span class="material-symbols-outlined">add</span> Add new </button>
                    </div>
                </ol>`
    }

    function addItem(elem) {
        console.log(elem)
        let itemCount = $('li.dd-item').length + 1
        console.log("itemCount = ", itemCount);
        console.log(elem[0].querySelectorAll('li')[itemCount - 2])
        last_elem = elem[0].querySelectorAll('li')[itemCount - 2]
        elem.append(
            `<li class="dd-item" id="todo-${itemCount}">
                <h3 class="title dd-handle">Title<i class="material-icons">filter_none</i></h3>
                <div class="text" contenteditable="true">
                    wwPaul Rand once said, “The public is more familiar with bad fucking design than good design. It is, in effect, conditioned to prefer
                </div>
                <i class="material-icons" id="label blue">label</i>
                <div class="actions">
                    <i class="material-icons" id="color">palette</i><i class="material-icons">edit</i><i class="material-icons">insert_link</i><i class="material-icons">attach_file</i>
                </div>
            </li>`
        );
    }

    // 정민님 함수
    // 정민님 함수


    // 모달 열기
    function openModal(columnId) {
        var modal = document.getElementById("myModal");
        document.getElementById("modalColumnId").value = columnId;

        modal.style.display = "block";
        modal.style.zIndex = 9999;
    }

    // 모달 닫기
    function closeModal() {
        var modal = document.getElementById("myModal");
        modal.style.display = "none";
    }

    function createCardForm() {
        const authToken = getAuthorizationToken();

        // modal창에 숨어있는 columnId값을 가져옴
        const columnId = document.getElementById("modalColumnId").value;

        var name = $("#name").val(); // 이름 입력란의 값을 가져옴
        var description = $("#description").val(); // 설명 입력란의 값을 가져옴

        // AJAX 요청을 보냄
        $.ajax({
            url: '/cards', // 데이터를 보낼 서버의 엔드포인트 URL
            method: 'POST',
            headers: {
                'Authorization': authToken
            },
            contentType: 'application/json',
            // POST 요청
            data: JSON.stringify({
                name: name, // 이름 데이터
                description: description, // 설명 데이터
                columnId: columnId
                // boardId: 1
            }),
            success: function (card) {
                // 성공적으로 서버에 데이터를 전송한 후 할 일
                alert("저장이 성공적으로 완료되었습니다.");
                loadNewCard(card, columnId);
                closeModal();
                // document.replace = "/columns/board/1"

            },
            error: function (error) {
                // 요청 중 에러가 발생했을 때 처리할 내용
                console.error('카드 생성 중 오류가 발생했습니다:', error);
            }
        });
    }

    function deleteCardForm(ele) {
        const authToken = getAuthorizationToken();

        // 클릭된 요소의 부모인 <li> 엘리먼트를 가져옵니다.
        const listItem = $(ele).closest('.dd-item');
        // <li> 엘리먼트의 id 속성 값을 가져옵니다.
        const cardId = listItem.attr('id');
        // {card_id} 부분을 추출합니다.
        const extractedCardId = cardId.split('-')[1];
        // 추출된 card_id를 출력하거나 사용할 수 있습니다.
        console.log(extractedCardId);
        console.log("cardId " + extractedCardId);
        // AJAX 요청을 보냄
        $.ajax({
            url: '/cards/' + extractedCardId,  // 데이터를 보낼 서버의 엔드포인트 URL
            method: 'DELETE',
            headers: {
                'Authorization': authToken
            },
            contentType: 'application/json',
            success: function (deleteCard) {
                alert("삭제되었습니다.");
                // 전체 카드 날리기 \
                // column-{columnId} 안에 todo-list ol 태그 안에 있는 애들 지우기

                const columnId = deleteCard.columnId;
                const columnToReload = $(`#column-${columnId}`);
                const cardList = columnToReload.find("#todo-list");
                cardList.empty();

                loadCardsByColumnId(columnId, authToken);

            },
            error: function (error) {
                // 요청 중 에러가 발생했을 때 처리할 내용
                alert("삭제 실패하였습니다.")
            }
        });
    }

    function loadNewCard(card, columnId) {
        const newCardHtml = cardTemplate
            .replace("{card_id}", card.id)
            .replace("{card_name}", card.name)
            .replace("{card_description}", card.description)
        $(newCardHtml).appendTo(`#column-${columnId} .todo-list`);
    }

    function loadNewColumn(column) {
        const columnHtml = columnTemplate
            .replace('{columnId}', column.columnId)
            .replace('{name}', column.title);
        console.log(columnHtml)
        $('#column-new-position').before(columnHtml);
        lastColumnPosition = column.position;
    }

    function loadColumns(boardId, authToken) {
        $.ajax({
            url: '/columns/boards/' + boardId,
            type: 'GET',
            headers: {
                'Authorization': authToken
            },
            success: function (columns) {
                console.log(columns);
                for (const column of columns) {

                    const columnHtml = columnTemplate
                        .replace('{columnId}', column.columnId)
                        .replace('{name}', column.name);

                    $('#column-new-position').before(columnHtml);
                    loadCardsByColumnId(column.columnId, authToken);
                    lastColumnPosition = column.position;

                    // Pass the columnId when opening the modal
                    $(`#column-${column.columnId} #create-card`).click(function () {
                        openModal(column.columnId);
                    });
                }
            },
            error: function (error) {
                console.log('Error:', error);
            }
        });
    }

    function loadCardsByColumnId(columnId, authToken) {
        $.ajax({
            url: '/cards/columns/' + columnId,
            type: 'GET',
            headers: {
                'Authorization': authToken
            },
            success: function (cards) {
                for (const card of cards) {
                    const newCardHtml = cardTemplate
                        .replace("{card_id}", card.id)
                        .replace("{card_name}", card.name)
                        .replace("{card_description}", card.description)
                    $(newCardHtml).appendTo(`#column-${columnId} .todo-list`);
                    $(`#card-${card.id} #cardIdValue`).val(card.id);
                }
            },
            error: function (error) {
                console.log('Error:', error);
            }
        });
    }


    function addColumn(authToken) {
        // boardId,
        // title
        let boardId = 1
        let title = "생성된 컬럼";
        $.ajax({
            type: "POST",
            url: `/columns`,
            contentType: "application/json",
            data: JSON.stringify({boardId: boardId, title: title}),
            headers: {
                'Authorization': authToken
            }
        })
            .done(function (res, status, xhr) {
                loadNewColumn(res);
            })
            .fail(function (jqXHR, textStatus) {
                const errorMessage = jqXHR.responseText;
                alert(`${errorMessage}`);
            });
    }

</script>

<div class="wrapper">
    <div class="kanban__title">
        <h1 style="font-family: 'Poppins', sans-serif;">Hanghaero</h1></div>

    <div class="dd" id="column-list">
        <ol class="addcolumn" id="column-new-position">
            <div class="actions">
                <button class="addbutt" id="add-column"><i class="material-icons">+</i></button>
            </div>
        </ol>
    </div>

    <menu class="kanban">
        <button style="font-family: 'Poppins', sans-serif;">settings</button>
        <button style="font-family: 'Poppins', sans-serif;">chevron_left</button>
        <button style="font-family: 'Poppins', sans-serif;" class="viewkanban">view_column</button>
        <button style="font-family: 'Poppins', sans-serif;" class="viewlist">view_list</button>
        <button style="font-family: 'Poppins', sans-serif;">playlist_add</button>
    </menu>
</div>

<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <form action="/cards" method="POST">
            <li class="dd-item" id="todo-${itemCount}">
                <input type="hidden" id="modalColumnId" name="modalColumnId">
                <div class="input-form-box"><span class="modalfont">제목</span><input type="text" id="name" name="name"
                                                                                    class="form-control"></div>
                <div class="input-form-box"><span class="modalfont">내용</span><input type="text" id="description"
                                                                                    name="description"
                                                                                    class="form-control">
                </div>
                <div class="actions">
                    <button onclick="createCardForm()" type="button" class="btn btn-primary btn-xs"
                            style="font-family: 'Poppins', sans-serif; width : 100%;">
                        저장
                    </button>
                </div>
            </li>
        </form>
    </div>
</div>
<script src="/js/basic.js"></script>
</body>
</html>
