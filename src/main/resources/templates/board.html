<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your HTML Document</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!-- 외부 스타일 시트를 링크합니다. -->
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"
            integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
</head>
<body>

<div id="p1" class="mdl-progress mdl-js-progress"></div>
<script>

    document.querySelector('#p1').addEventListener('mdl-componentupgraded', function () {
        this.MaterialProgress.setProgress(44);
    });

    let lastColumnPosition = 0;

    $(document).ready(function () {
        const authToken = getAuthorizationToken();
        loadColumns(1, authToken);
        // $("#delete-button").click(function(){
        //     addItem();
        // });
        $("#add-column").click(function () {
            addColumn(authToken);
        });
    });

    const columnTemplate =
        `
        <ol class="column" id="column-{columnId}">
            <div class="kanban__title">
                <h2><i class="material-icons">{name}</i></h2>
            </div>

            <ol class="todo-list" id="todo-list">
<!--                카드들이 들어갈곳-->
            </ol>

            <div class="actions">
                <button id="create-card" class="addbutt" onclick="openModal({columnId})">ADD NEW</button>
            </div>
        </ol>
        `

    // 모달 열기
    function openModal(columnId) {
        var modal = document.getElementById("myModal");
        document.getElementById("modalColumnId").value = columnId;

        modal.style.display = "block";
        modal.style.zIndex = 9999;
    }

    // 모달 닫기
    function closeModal() {
        var modal = document.getElementById("myModal");
        modal.style.display = "none";
    }

    function createCardForm() {
        const authToken = getAuthorizationToken();

        // modal창에 숨어있는 columnId값을 가져옴
        const columnId = document.getElementById("modalColumnId").value;

        var name = $("#name").val(); // 이름 입력란의 값을 가져옴
        var description = $("#description").val(); // 설명 입력란의 값을 가져옴

        // AJAX 요청을 보냄
        $.ajax({
            url: '/cards', // 데이터를 보낼 서버의 엔드포인트 URL
            method: 'POST',
            headers: {
                'Authorization': authToken
            },
            contentType: 'application/json',
            // POST 요청
            data: JSON.stringify({
                name: name, // 이름 데이터
                description: description, // 설명 데이터
                columnId: columnId
                // boardId: 1
            }),
            success: function (card) {
                // 성공적으로 서버에 데이터를 전송한 후 할 일
                alert("저장이 성공적으로 완료되었습니다.");
                loadNewCard(card, columnId);
                closeModal();
                // document.replace = "/columns/board/1"

            },
            error: function (error) {
                // 요청 중 에러가 발생했을 때 처리할 내용
                console.error('카드 생성 중 오류가 발생했습니다:', error);
            }
        });
    }

    // $(document).ready(function () {
    //     $('.close').on('click', function () {
    //         var cardId = $(this).closest('.card').data('card-id'); // 카드의 고유 ID 가져오기
    //
    //         $.ajax({
    //             type: 'DELETE',
    //             url: '/cards/' + cardId, // 카드 삭제 엔드포인트 URL
    //             success: function (response) {
    //                 // 서버에서 카드 삭제 성공 시 화면에서도 삭제
    //                 $(this).closest('.card').remove(); // 해당 카드 요소를 DOM에서 삭제
    //                 console.log('카드가 삭제되었습니다.');
    //             },
    //             error: function (error) {
    //                 console.error('카드 삭제 중 오류 발생:', error);
    //             }
    //         });
    //     });
    // });

    function deleteCardForm() {
        const authToken = getAuthorizationToken();
        const cardId = document.getElementById("modalCardId").value;
        // AJAX 요청을 보냄
        $.ajax({
            url: '/cards/' + cardId,  // 데이터를 보낼 서버의 엔드포인트 URL
            method: 'DELETE',
            headers: {
                'Authorization': authToken
            },
            contentType: 'application/json',
            success: function () {
                // 성공적으로 서버에 데이터를 전송한 후 할 일
                alert("삭제되었습니다.");
            },
            error: function (error) {
                // 요청 중 에러가 발생했을 때 처리할 내용
                alert("삭제 실패하였습니다.")
            }
        });
    }

    function loadNewCard(card, columnId) {
        const newCardHtml = cardTemplate
            .replace("{card_id}", card.id)
            .replace("{card_name}", card.name)
            .replace("{card_description}", card.description)
        $(newCardHtml).appendTo(`#column-${columnId} .todo-list`);
    }

    function loadNewColumn(column) {
        const columnHtml = columnTemplate
            .replace('{columnId}', column.columnId)
            .replace('{name}', column.name);
        console.log(columnHtml)
        $('#column-new-position').before(columnHtml);
        lastColumnPosition = column.position;
    }

    function loadColumns(boardId, authToken) {
        $.ajax({
            url: '/columns/boards/' + boardId,
            type: 'GET',
            headers: {
                'Authorization': authToken
            },
            success: function (columns) {
                console.log(columns);
                for (const column of columns) {

                    const columnHtml = columnTemplate
                        .replace('{columnId}', column.columnId)
                        .replace('{name}', column.name);

                    $('#column-new-position').before(columnHtml);
                    loadCardsByColumnId(column.columnId, authToken);
                    lastColumnPosition = column.position;

                    // Pass the columnId when opening the modal
                    $(`#column-${column.columnId} #create-card`).click(function () {
                        openModal(column.columnId);
                    });
                }
            },
            error: function (error) {
                console.log('Error:', error);
            }
        });
    }

    const cardTemplate =
        `
        <li class="dd-item" id="card-{card_Id}" >
            <input type="hidden" id="modalCardId" name="modalCardId">
            <span class="close" onclick=deleteCardForm()>&times;</span>
            <h3 class="title dd-handle">
                <i class=" material-icons ">filter_none</i>
                {card_name}
            </h3>
            <div class="text" contenteditable="true">
                {card_description}
            </div>
            <div class="actions">
               {card_dueDate}
            </div>
        </li>
        `

    function loadCardsByColumnId(columnId, authToken) {
        $.ajax({
            url: '/cards/columns/' + columnId,
            type: 'GET',
            headers: {
                'Authorization': authToken
            },
            success: function (cards) {
                for (const card of cards) {
                    const newCardHtml = cardTemplate
                        .replace("{card_id}", card.id)
                        .replace("{card_name}", card.name)
                        .replace("{card_description}", card.description)
                    $(newCardHtml).appendTo(`#column-${columnId} .todo-list`);
                }
            },
            error: function (error) {
                console.log('Error:', error);
            }
        });
    }


    function addColumn(authToken) {
        // boardId,
        // title
        let boardId = 1
        let title = "생성된 컬럼";
        $.ajax({
            type: "POST",
            url: `/columns`,
            contentType: "application/json",
            data: JSON.stringify({boardId: boardId, title: title}),
            headers: {
                'Authorization': authToken
            }
        })
            .done(function (res, status, xhr) {
                loadNewColumn(res);
            })
            .fail(function (jqXHR, textStatus) {
                const errorMessage = jqXHR.responseText;
                alert(`${errorMessage}`);
            });
    }

</script>

<div class="wrapper">
    <div class="kanban__title">
        <h1><i class="material-icons">check</i> To do list</h1></div>

    <div class="dd" id="column-list">
        <ol class="addcolumn" id="column-new-position">
            <div class="actions">
                <button class="addbutt" id="add-column"><i class="material-icons">+</i></button>
            </div>
        </ol>
    </div>

    <menu class="kanban">
        <button><i class="material-icons">settings</i></button>
        <button><i class="material-icons">chevron_left</i></button>
        <button class="viewkanban"><i class="material-icons ">view_column</i></button>
        <button class="viewlist"><i class="material-icons">view_list</i></button>
        <button><i class="material-icons">playlist_add</i> Add new Column</button>
    </menu>
</div>

<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <form action="/cards" method="POST">
            <li class="dd-item" id="todo-${itemCount}">
                <input type="hidden" id="modalColumnId" name="modalColumnId">
                <div class="input-form-box"><span>제목 </span><input type="text" id="name" name="name"
                                                                   class="form-control"></div>
                <div class="input-form-box"><span>내용 </span><input type="text" id="description" name="description"
                                                                   class="form-control">
                </div>
                <div class="actions">
                    <button onclick="createCardForm()" type="button" class="btn btn-primary btn-xs" style="width:100%">
                        저장
                    </button>
                </div>
            </li>
        </form>
    </div>
</div>

<script src="/js/basic.js"></script>
</body>
</html>
