<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your HTML Document</title>
    <!-- 외부 스타일 시트를 링크합니다. -->
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"
            integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
</head>
<body>

<div id="p1" class="mdl-progress mdl-js-progress"></div>
<script>
    document.querySelector('#p1').addEventListener('mdl-componentupgraded', function () {
        this.MaterialProgress.setProgress(44);
    });

    let lastColumnPosition = 0;

    $(document).ready(function () {
        const authToken = getAuthorizationToken();
        loadColumns(1, authToken);
        $("#test-button").click(function(){
            addItem();
        });
        $("#add-column").click(function(){
            addColumn(authToken);
        });
    });

    const columnTemplate =
        `
        <ol class="column" id="column-{columnId}">
            <div class="kanban__title">
                <h2><i class="material-icons">{name}</i></h2>
            </div>

            <ol class="todo-list" id="todo-list">
<!--                카드들이 들어갈곳-->
            </ol>

            <div class="actions">
                <button id="test-button" class="addbutt"><i class="material-icons">control_point</i> Add new</button>
            </div>
        </ol>
    `

    function loadNewColumn(column){
        const columnHtml = columnTemplate
            .replace('{columnId}', column.columnId)
            .replace('{name}', column.name);

        $('#column-new-position').before(columnHtml);
        lastColumnPosition = column.position;
    }


    function loadColumns(boardId, authToken){
        $.ajax({
            url: '/columns/boards/' +boardId,
            type: 'GET',
            headers: {
                'Authorization': authToken
            },
            success: function (columns) {
                console.log(columns);
                for (const column of columns) {

                    const columnHtml = columnTemplate
                        .replace('{columnId}', column.columnId)
                        .replace('{name}', column.name);

                    $('#column-new-position').before( columnHtml);
                    loadCardsByColumnId(column.columnId, authToken);
                    lastColumnPosition = column.position;
                }
            },
            error: function (error) {
                console.log('Error:', error);
            }
        });
    }

    function loadCardsByColumnId(columnId, authToken){
        $.ajax({
            url: '/cards/columns/' + columnId,
            type: 'GET',
            headers: {
                'Authorization': authToken
            },
            success: function (cards) {
                for (const card of cards) {
                    const newCardHtml =`
                        <li class="dd-item" id="card-${card.id}" >
                            <h3 class="title dd-handle">
                                <i class=" material-icons ">filter_none</i>
                                ${card.name}
                            </h3>
                            <div class="text" contenteditable="true">
                                ${card.description}
                            </div>
                            <div class="actions">
                               ${card.dueDate}
                            </div>
                        </li>`
                    $(newCardHtml).appendTo(`#column-${columnId} .todo-list`);
                }
            },
            error: function (error) {
                console.log('Error:', error);
            }
        });
    }

    function addColumn(authToken){
        // boardId,
        // title
        let boardId = 1
        let title = "생성된 컬럼";
        $.ajax({
            type: "POST",
            url: `/columns`,
            contentType: "application/json",
            data: JSON.stringify({boardId: boardId, title: title}),
            headers:{
                'Authorization' : authToken
            }
        })
            .done(function (res, status, xhr) {
                loadNewColumn(res);
            })
            .fail(function (jqXHR, textStatus) {
                const errorMessage = jqXHR.responseText;
                alert(`${errorMessage}`);
            });
    }



    // 모달 열기
    function openModal() {
        var modal = document.getElementById("myModal");
        modal.style.display = "block";
    }

    // 모달 닫기
    function closeModal() {
        var modal = document.getElementById("myModal");
        modal.style.display = "none";
    }
    function createCardForm() {
        const authToken = getAuthorizationToken();

        var name = $("#name").val(); // 이름 입력란의 값을 가져옴
        var description = $("#description").val(); // 설명 입력란의 값을 가져옴

        // AJAX 요청을 보냄
        $.ajax({
            url: '/cards', // 데이터를 보낼 서버의 엔드포인트 URL
            method: 'POST',
            headers: {
                'Authorization': authToken
            },
            contentType: 'application/json',
            // POST 요청
            data: JSON.stringify({
                name: name, // 이름 데이터
                description: description, // 설명 데이터
                columnId: 1,
                userId: 1,
                boardId: 1
            }),
            success: function (response) {
                // 성공적으로 서버에 데이터를 전송한 후 할 일
                console.log('카드가 성공적으로 생성되었습니다.');
            },
            error: function (error) {
                // 요청 중 에러가 발생했을 때 처리할 내용
                console.error('카드 생성 중 오류가 발생했습니다:', error);
            }
        });
    }


    function addItem() {
        let itemCount = $("#todo-list li").length + 1;

        $("#todo-list").append(
            `<form action="/cards" method="POST">
                <li class="dd-item" id="todo-${itemCount}">

<!--                <div class="text" contenteditable="true">-->
<!--                    <h3>-->
                        <input type="Text" id="name" name="name">
<!--                    </h3>-->
<!--                </div>-->
<!--                <div class="text" contenteditable="true">-->
                    <input type="Text" id="description" name="description">
<!--                </div>-->
                <div class="actions">
                    <button onclick="createCardForm()" type="button">저장</button>
                </div>
                </li>
            </form>`

        );
    }
</script>


<!-- 버튼 클릭 시 모달 열기 -->
<button onclick="openModal()">모달 열기</button>
<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <p>모달 내용을 여기에 작성합니다.</p>
    </div>
</div>

<div class="wrapper">
    <div class="kanban__title">
        <h1><i class="material-icons">check</i> To do list</h1></div>

    <div class="dd" id="column-list">
        <ol class="addcolumn" id="column-new-position">
            <div class="actions">
                <button class="addbutt" id="add-column"><i class="material-icons">+</i></button>
            </div>
        </ol>
    </div>

    <menu class="kanban">
        <button><i class="material-icons">settings</i></button>
        <button><i class="material-icons">chevron_left</i></button>
        <button class="viewkanban"><i class="material-icons ">view_column</i></button>
        <button class="viewlist"><i class="material-icons">view_list</i></button>
        <button><i class="material-icons">playlist_add</i> Add new Column</button>
    </menu>
</div>

<script src="/js/basic.js"></script>
</body>
</html>
